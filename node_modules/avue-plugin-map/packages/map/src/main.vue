<template>
  <div class="avue-map">
    <el-button @click="box=true"
               class="avue-map__submit">{{textTitle}}</el-button>
    <el-dialog fullscreen
               class="avue-map__dialog"
               width="100%"
               append-to-body
               modal-append-to-body
               title="选择坐标"
               @close="handleClose"
               :visible.sync="box">
      <div class="avue-map__content"
           v-if="box">
        <el-input class="avue-map__content-input"
                  id="map__input"
                  size="small"
                  v-model="text"
                  clearable
                  placeholder="输入关键字选取地点"></el-input>
        <div class="avue-map__content-box">
          <div id="map__container"
               class="avue-map__content-container"
               tabindex="0"></div>
          <div id="map__result"
               class="avue-map__content-result"></div>
        </div>
      </div>
      <span slot="footer"
            class="dialog-footer">
        <el-button type="primary"
                   @click="handleSubmit()">确 定</el-button>
      </span>
    </el-dialog>
  </div>
</template>
<script>
export default {
  name: 'AvueMap',
  props: {
    value: {
      type: Object,
      default: () => {
        return {}
      }
    }
  },
  data () {
    return {
      poi: {},
      text: '',
      box: false,
    }
  },
  watch: {
    box () {
      if (this.box) {
        this.$nextTick(() => this.init())

      }
    }
  },
  computed: {
    textTitle () {
      return this.poi.name === undefined ? "选择坐标" : "重新选择";
    }
  },
  methods: {
    handleClose () {
      this.text = "";
      window.poiPicker.clearSearchResults();
      this.poi = {};
    },
    handleSubmit () {
      this.$emit('input', this.poi)
      this.poi = {};
      this.box = false;
    },
    init () {
      const safe = this;
      var map = new window.AMap.Map("map__container", {
        zoom: 15
      });
      window.AMapUI.loadUI(["misc/PoiPicker"], function (PoiPicker) {
        var poiPicker = new PoiPicker({
          input: "map__input",
          placeSearchOptions: {
            map: map,
            pageSize: 10
          },
          searchResultsContainer: "map__result"
        });
        //初始化poiPicker
        poiPickerReady(poiPicker);
      });
      function poiPickerReady (poiPicker) {
        window.poiPicker = poiPicker;
        //选取了某个POI
        poiPicker.on("poiPicked", function (poiResult) {
          var source = poiResult.source,
            poi = poiResult.item;
          safe.text = poi.name;
          safe.poi = poi;
          if (source !== "search") {
            poiPicker.searchByKeyword(poi.name);
          }
        });
      }
    }
  }
}
</script>

<style lang="scss">
.avue-map{
  &__submit{
    width: 100%;
  }
  &__content{
    &-input {
      margin-bottom: 10px;
    }
    &-box {
        position: relative;
      }
    &-container {
        width: 100%;
        height: 450px;
      }
    &-result {
        display: block !important;
        position: absolute;
        top: 0;
        right: -8px;
        width: 250px;
        height: 450px;
        overflow-y: auto;
    }
  }
}

</style>
